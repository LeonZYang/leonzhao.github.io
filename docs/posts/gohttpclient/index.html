<!DOCTYPE html>
<html lang="zh-cn">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Go-深入理解HTTP Client">
<meta itemprop="description" content="深入理解HTTP Client 数据结构 Client type Client struct { // HTTP Requests的 	Transport RoundTripper // HTTP重定向 	CheckRedirect func(req *Request, via []*Request) error // Cookie 	Jar CookieJar // 客户端请求的超时时间，默认为0，代表永远不超时 	Timeout time.Duration } Transport Transport会缓存连接进行重用
type Transport struct { idleMu sync.Mutex wantIdle bool // user has requested to close all idle conns  // connectMethodKey 是一个map key，保存了proxy, schema, addr，然后排列生成一个字符串 	idleConn map[connectMethodKey][]*persistConn // 从最近到最晚 	idleConnCh map[connectMethodKey]chan *persistConn idleLRU connLRU reqMu sync.">
<meta itemprop="datePublished" content="2021-06-27T09:36:17+08:00" />
<meta itemprop="dateModified" content="2021-06-27T09:36:17+08:00" />
<meta itemprop="wordCount" content="5027">



<meta itemprop="keywords" content="" />
<meta property="og:title" content="Go-深入理解HTTP Client" />
<meta property="og:description" content="深入理解HTTP Client 数据结构 Client type Client struct { // HTTP Requests的 	Transport RoundTripper // HTTP重定向 	CheckRedirect func(req *Request, via []*Request) error // Cookie 	Jar CookieJar // 客户端请求的超时时间，默认为0，代表永远不超时 	Timeout time.Duration } Transport Transport会缓存连接进行重用
type Transport struct { idleMu sync.Mutex wantIdle bool // user has requested to close all idle conns  // connectMethodKey 是一个map key，保存了proxy, schema, addr，然后排列生成一个字符串 	idleConn map[connectMethodKey][]*persistConn // 从最近到最晚 	idleConnCh map[connectMethodKey]chan *persistConn idleLRU connLRU reqMu sync." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leonzyang.github.io/posts/gohttpclient/" />
<meta property="article:published_time" content="2021-06-27T09:36:17+08:00" />
<meta property="article:modified_time" content="2021-06-27T09:36:17+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go-深入理解HTTP Client"/>
<meta name="twitter:description" content="深入理解HTTP Client 数据结构 Client type Client struct { // HTTP Requests的 	Transport RoundTripper // HTTP重定向 	CheckRedirect func(req *Request, via []*Request) error // Cookie 	Jar CookieJar // 客户端请求的超时时间，默认为0，代表永远不超时 	Timeout time.Duration } Transport Transport会缓存连接进行重用
type Transport struct { idleMu sync.Mutex wantIdle bool // user has requested to close all idle conns  // connectMethodKey 是一个map key，保存了proxy, schema, addr，然后排列生成一个字符串 	idleConn map[connectMethodKey][]*persistConn // 从最近到最晚 	idleConnCh map[connectMethodKey]chan *persistConn idleLRU connLRU reqMu sync."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Go-深入理解HTTP Client</title>
	<link rel="stylesheet" href="https://leonzyang.github.io/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css" integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://leonzyang.github.io">LeonZhao的小木屋</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://leonzyang.github.io/posts/">博客</a>
				<a href="https://leonzyang.github.io/datastruct/">数据结构</a>
				<a href="https://leonzyang.github.io/algo/">算法</a>
				<a href="https://leonzyang.github.io/network/">网络</a>
				<a href="https://leonzyang.github.io/interview/">面试</a>
				<a href="https://leonzyang.github.io/about/">关于</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://github.com/" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://leonzyang.github.io/posts/">博客</a></li>
			<li><a href="https://leonzyang.github.io/datastruct/">数据结构</a></li>
			<li><a href="https://leonzyang.github.io/algo/">算法</a></li>
			<li><a href="https://leonzyang.github.io/network/">网络</a></li>
			<li><a href="https://leonzyang.github.io/interview/">面试</a></li>
			<li><a href="https://leonzyang.github.io/about/">关于</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jun 27, 2021</span></div>
				<h1>Go-深入理解HTTP Client</h1>
			</header>
			<div class="content">
				<h2 id="深入理解http-client">深入理解HTTP Client<a href="#深入理解http-client" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="数据结构">数据结构<a href="#数据结构" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<h4 id="client">Client<a href="#client" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Client</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// HTTP Requests的
</span><span class="c1"></span>	<span class="nx">Transport</span> <span class="nx">RoundTripper</span>

    <span class="c1">// HTTP重定向
</span><span class="c1"></span>	<span class="nx">CheckRedirect</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">via</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">error</span>

    <span class="c1">// Cookie
</span><span class="c1"></span>	<span class="nx">Jar</span> <span class="nx">CookieJar</span>

    <span class="c1">// 客户端请求的超时时间，默认为0，代表永远不超时
</span><span class="c1"></span>	<span class="nx">Timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="p">}</span>
</code></pre></div><h4 id="transport">Transport<a href="#transport" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>Transport会缓存连接进行重用</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Transport</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">idleMu</span>     <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="nx">wantIdle</span>   <span class="kt">bool</span>                                <span class="c1">// user has requested to close all idle conns
</span><span class="c1"></span>    <span class="c1">// connectMethodKey 是一个map key，保存了proxy, schema, addr，然后排列生成一个字符串
</span><span class="c1"></span>	<span class="nx">idleConn</span>   <span class="kd">map</span><span class="p">[</span><span class="nx">connectMethodKey</span><span class="p">][]</span><span class="o">*</span><span class="nx">persistConn</span> <span class="c1">// 从最近到最晚
</span><span class="c1"></span>	<span class="nx">idleConnCh</span> <span class="kd">map</span><span class="p">[</span><span class="nx">connectMethodKey</span><span class="p">]</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">persistConn</span> 
	<span class="nx">idleLRU</span>    <span class="nx">connLRU</span>

	<span class="nx">reqMu</span>       <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
	<span class="nx">reqCanceler</span> <span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">Request</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span>

	<span class="nx">altMu</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>   <span class="c1">// guards changing altProto only
</span><span class="c1"></span>	<span class="nx">altProto</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">Value</span> <span class="c1">// of nil or map[string]RoundTripper, key is URI scheme
</span><span class="c1"></span>
	<span class="nx">connCountMu</span>          <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
	<span class="nx">connPerHostCount</span>     <span class="kd">map</span><span class="p">[</span><span class="nx">connectMethodKey</span><span class="p">]</span><span class="kt">int</span>
	<span class="nx">connPerHostAvailable</span> <span class="kd">map</span><span class="p">[</span><span class="nx">connectMethodKey</span><span class="p">]</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>

	<span class="c1">// Proxy specifies a function to return a proxy for a given
</span><span class="c1"></span>	<span class="c1">// Request. If the function returns a non-nil error, the
</span><span class="c1"></span>	<span class="c1">// request is aborted with the provided error.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// The proxy type is determined by the URL scheme. &#34;http&#34;,
</span><span class="c1"></span>	<span class="c1">// &#34;https&#34;, and &#34;socks5&#34; are supported. If the scheme is empty,
</span><span class="c1"></span>	<span class="c1">// &#34;http&#34; is assumed.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// If Proxy is nil or returns a nil *URL, no proxy is used.
</span><span class="c1"></span>	<span class="nx">Proxy</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// DialContext specifies the dial function for creating unencrypted TCP connections.
</span><span class="c1"></span>	<span class="c1">// If DialContext is nil (and the deprecated Dial below is also nil),
</span><span class="c1"></span>	<span class="c1">// then the transport dials using package net.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// DialContext runs concurrently with calls to RoundTrip.
</span><span class="c1"></span>	<span class="c1">// A RoundTrip call that initiates a dial may end up using
</span><span class="c1"></span>	<span class="c1">// a connection dialed previously when the earlier connection
</span><span class="c1"></span>	<span class="c1">// becomes idle before the later DialContext completes.
</span><span class="c1"></span>	<span class="nx">DialContext</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">network</span><span class="p">,</span> <span class="nx">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// Dial specifies the dial function for creating unencrypted TCP connections.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// Dial runs concurrently with calls to RoundTrip.
</span><span class="c1"></span>	<span class="c1">// A RoundTrip call that initiates a dial may end up using
</span><span class="c1"></span>	<span class="c1">// a connection dialed previously when the earlier connection
</span><span class="c1"></span>	<span class="c1">// becomes idle before the later Dial completes.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// Deprecated: Use DialContext instead, which allows the transport
</span><span class="c1"></span>	<span class="c1">// to cancel dials as soon as they are no longer needed.
</span><span class="c1"></span>	<span class="c1">// If both are set, DialContext takes priority.
</span><span class="c1"></span>	<span class="nx">Dial</span> <span class="kd">func</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// DialTLS specifies an optional dial function for creating
</span><span class="c1"></span>	<span class="c1">// TLS connections for non-proxied HTTPS requests.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// If DialTLS is nil, Dial and TLSClientConfig are used.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// If DialTLS is set, the Dial hook is not used for HTTPS
</span><span class="c1"></span>	<span class="c1">// requests and the TLSClientConfig and TLSHandshakeTimeout
</span><span class="c1"></span>	<span class="c1">// are ignored. The returned net.Conn is assumed to already be
</span><span class="c1"></span>	<span class="c1">// past the TLS handshake.
</span><span class="c1"></span>	<span class="nx">DialTLS</span> <span class="kd">func</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// TLSClientConfig specifies the TLS configuration to use with
</span><span class="c1"></span>	<span class="c1">// tls.Client.
</span><span class="c1"></span>	<span class="c1">// If nil, the default configuration is used.
</span><span class="c1"></span>	<span class="c1">// If non-nil, HTTP/2 support may not be enabled by default.
</span><span class="c1"></span>	<span class="nx">TLSClientConfig</span> <span class="o">*</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span>

	<span class="c1">// TLSHandshakeTimeout specifies the maximum amount of time waiting to
</span><span class="c1"></span>	<span class="c1">// wait for a TLS handshake. Zero means no timeout.
</span><span class="c1"></span>	<span class="nx">TLSHandshakeTimeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>

	<span class="c1">// DisableKeepAlives, if true, disables HTTP keep-alives and
</span><span class="c1"></span>	<span class="c1">// will only use the connection to the server for a single
</span><span class="c1"></span>	<span class="c1">// HTTP request.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// This is unrelated to the similarly named TCP keep-alives.
</span><span class="c1"></span>	<span class="nx">DisableKeepAlives</span> <span class="kt">bool</span>

	<span class="c1">// DisableCompression, if true, prevents the Transport from
</span><span class="c1"></span>	<span class="c1">// requesting compression with an &#34;Accept-Encoding: gzip&#34;
</span><span class="c1"></span>	<span class="c1">// request header when the Request contains no existing
</span><span class="c1"></span>	<span class="c1">// Accept-Encoding value. If the Transport requests gzip on
</span><span class="c1"></span>	<span class="c1">// its own and gets a gzipped response, it&#39;s transparently
</span><span class="c1"></span>	<span class="c1">// decoded in the Response.Body. However, if the user
</span><span class="c1"></span>	<span class="c1">// explicitly requested gzip it is not automatically
</span><span class="c1"></span>	<span class="c1">// uncompressed.
</span><span class="c1"></span>	<span class="nx">DisableCompression</span> <span class="kt">bool</span>

	<span class="c1">// MaxIdleConns controls the maximum number of idle (keep-alive)
</span><span class="c1"></span>    <span class="c1">// connections across all hosts. Zero means no limit.
</span><span class="c1"></span>    <span class="c1">// 所有host的最大空闲连接数
</span><span class="c1"></span>	<span class="nx">MaxIdleConns</span> <span class="kt">int</span>

	<span class="c1">// MaxIdleConnsPerHost, if non-zero, controls the maximum idle
</span><span class="c1"></span>	<span class="c1">// (keep-alive) connections to keep per-host. If zero,
</span><span class="c1"></span>    <span class="c1">// DefaultMaxIdleConnsPerHost is used.
</span><span class="c1"></span>    <span class="c1">// 每个host的最大空闲连接数
</span><span class="c1"></span>	<span class="nx">MaxIdleConnsPerHost</span> <span class="kt">int</span>

	<span class="c1">// MaxConnsPerHost optionally limits the total number of
</span><span class="c1"></span>	<span class="c1">// connections per host, including connections in the dialing,
</span><span class="c1"></span>	<span class="c1">// active, and idle states. On limit violation, dials will block.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// Zero means no limit.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// For HTTP/2, this currently only controls the number of new
</span><span class="c1"></span>	<span class="c1">// connections being created at a time, instead of the total
</span><span class="c1"></span>	<span class="c1">// number. In practice, hosts using HTTP/2 only have about one
</span><span class="c1"></span>    <span class="c1">// idle connection, though.
</span><span class="c1"></span>    <span class="c1">// 每个host的最大连接数
</span><span class="c1"></span>	<span class="nx">MaxConnsPerHost</span> <span class="kt">int</span>

	<span class="c1">// IdleConnTimeout is the maximum amount of time an idle
</span><span class="c1"></span>	<span class="c1">// (keep-alive) connection will remain idle before closing
</span><span class="c1"></span>	<span class="c1">// itself.
</span><span class="c1"></span>    <span class="c1">// Zero means no limit.
</span><span class="c1"></span>    <span class="c1">// 空闲连接的过期时间
</span><span class="c1"></span>	<span class="nx">IdleConnTimeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>

	<span class="c1">// ResponseHeaderTimeout, if non-zero, specifies the amount of
</span><span class="c1"></span>	<span class="c1">// time to wait for a server&#39;s response headers after fully
</span><span class="c1"></span>	<span class="c1">// writing the request (including its body, if any). This
</span><span class="c1"></span>	<span class="c1">// time does not include the time to read the response body.
</span><span class="c1"></span>	<span class="nx">ResponseHeaderTimeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>

	<span class="c1">// ExpectContinueTimeout, if non-zero, specifies the amount of
</span><span class="c1"></span>	<span class="c1">// time to wait for a server&#39;s first response headers after fully
</span><span class="c1"></span>	<span class="c1">// writing the request headers if the request has an
</span><span class="c1"></span>	<span class="c1">// &#34;Expect: 100-continue&#34; header. Zero means no timeout and
</span><span class="c1"></span>	<span class="c1">// causes the body to be sent immediately, without
</span><span class="c1"></span>	<span class="c1">// waiting for the server to approve.
</span><span class="c1"></span>	<span class="c1">// This time does not include the time to send the request header.
</span><span class="c1"></span>	<span class="nx">ExpectContinueTimeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>

	<span class="c1">// TLSNextProto specifies how the Transport switches to an
</span><span class="c1"></span>	<span class="c1">// alternate protocol (such as HTTP/2) after a TLS NPN/ALPN
</span><span class="c1"></span>	<span class="c1">// protocol negotiation. If Transport dials an TLS connection
</span><span class="c1"></span>	<span class="c1">// with a non-empty protocol name and TLSNextProto contains a
</span><span class="c1"></span>	<span class="c1">// map entry for that key (such as &#34;h2&#34;), then the func is
</span><span class="c1"></span>	<span class="c1">// called with the request&#39;s authority (such as &#34;example.com&#34;
</span><span class="c1"></span>	<span class="c1">// or &#34;example.com:1234&#34;) and the TLS connection. The function
</span><span class="c1"></span>	<span class="c1">// must return a RoundTripper that then handles the request.
</span><span class="c1"></span>	<span class="c1">// If TLSNextProto is not nil, HTTP/2 support is not enabled
</span><span class="c1"></span>	<span class="c1">// automatically.
</span><span class="c1"></span>	<span class="nx">TLSNextProto</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="nx">authority</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="nx">RoundTripper</span>

	<span class="c1">// ProxyConnectHeader optionally specifies headers to send to
</span><span class="c1"></span>	<span class="c1">// proxies during CONNECT requests.
</span><span class="c1"></span>	<span class="nx">ProxyConnectHeader</span> <span class="nx">Header</span>

	<span class="c1">// MaxResponseHeaderBytes specifies a limit on how many
</span><span class="c1"></span>	<span class="c1">// response bytes are allowed in the server&#39;s response
</span><span class="c1"></span>	<span class="c1">// header.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// Zero means to use a default limit.
</span><span class="c1"></span>	<span class="nx">MaxResponseHeaderBytes</span> <span class="kt">int64</span>

	<span class="c1">// nextProtoOnce guards initialization of TLSNextProto and
</span><span class="c1"></span>	<span class="c1">// h2transport (via onceSetNextProtoDefaults)
</span><span class="c1"></span>	<span class="nx">nextProtoOnce</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
	<span class="nx">h2transport</span>   <span class="nx">h2Transport</span> <span class="c1">// non-nil if http2 wired up
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><h4 id="persistconn">persistConn<a href="#persistconn" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>persistConn封装了一个连接，表示持久连接</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">persistConn</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// alt optionally specifies the TLS NextProto RoundTripper.
</span><span class="c1"></span>	<span class="c1">// This is used for HTTP/2 today and future protocols later.
</span><span class="c1"></span>	<span class="c1">// If it&#39;s non-nil, the rest of the fields are unused.
</span><span class="c1"></span>	<span class="nx">alt</span> <span class="nx">RoundTripper</span>

	<span class="nx">t</span>         <span class="o">*</span><span class="nx">Transport</span>
	<span class="nx">cacheKey</span>  <span class="nx">connectMethodKey</span>
	<span class="nx">conn</span>      <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span>
	<span class="nx">tlsState</span>  <span class="o">*</span><span class="nx">tls</span><span class="p">.</span><span class="nx">ConnectionState</span>
	<span class="nx">br</span>        <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span>       <span class="c1">// from conn
</span><span class="c1"></span>	<span class="nx">bw</span>        <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Writer</span>       <span class="c1">// to conn
</span><span class="c1"></span>	<span class="nx">nwrite</span>    <span class="kt">int64</span>               <span class="c1">// bytes written
</span><span class="c1"></span>	<span class="c1">// roundTrip 写， readLoop 读
</span><span class="c1"></span>	<span class="nx">reqch</span>     <span class="kd">chan</span> <span class="nx">requestAndChan</span> <span class="c1">// written by roundTrip; read by readLoop
</span><span class="c1"></span>	<span class="c1">// roundTrip 写，writeLoop读
</span><span class="c1"></span>	<span class="nx">writech</span>   <span class="kd">chan</span> <span class="nx">writeRequest</span>   <span class="c1">// written by roundTrip; read by writeLoop
</span><span class="c1"></span>	<span class="c1">// 当连接closed，该chan会被close
</span><span class="c1"></span>	<span class="nx">closech</span>   <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>       <span class="c1">// closed when conn closed
</span><span class="c1"></span>	<span class="nx">isProxy</span>   <span class="kt">bool</span>
	<span class="nx">sawEOF</span>    <span class="kt">bool</span>  <span class="c1">// whether we&#39;ve seen EOF from conn; owned by readLoop
</span><span class="c1"></span>	<span class="nx">readLimit</span> <span class="kt">int64</span> <span class="c1">// bytes allowed to be read; owned by readLoop
</span><span class="c1"></span>	<span class="c1">// writeErrCh passes the request write error (usually nil)
</span><span class="c1"></span>	<span class="c1">// from the writeLoop goroutine to the readLoop which passes
</span><span class="c1"></span>	<span class="c1">// it off to the res.Body reader, which then uses it to decide
</span><span class="c1"></span>	<span class="c1">// whether or not a connection can be reused. Issue 7569.
</span><span class="c1"></span>	<span class="nx">writeErrCh</span> <span class="kd">chan</span> <span class="kt">error</span>

	<span class="nx">writeLoopDone</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span> <span class="c1">// closed when write loop ends
</span><span class="c1"></span>
	<span class="c1">// Both guarded by Transport.idleMu:
</span><span class="c1"></span>	<span class="nx">idleAt</span>    <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>   <span class="c1">// time it last become idle
</span><span class="c1"></span>	<span class="nx">idleTimer</span> <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Timer</span> <span class="c1">// holding an AfterFunc to close it
</span><span class="c1"></span>
	<span class="nx">mu</span>                   <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span> <span class="c1">// guards following fields
</span><span class="c1"></span>	<span class="nx">numExpectedResponses</span> <span class="kt">int</span>
	<span class="c1">// 如果closed，则为非nil
</span><span class="c1"></span>	<span class="nx">closed</span>               <span class="kt">error</span> <span class="c1">// set non-nil when conn is closed, before closech is closed
</span><span class="c1"></span>	<span class="nx">canceledErr</span>          <span class="kt">error</span> <span class="c1">// set non-nil if conn is canceled
</span><span class="c1"></span>	<span class="c1">// 如果broken为true，则该链接不会复用
</span><span class="c1"></span>	<span class="nx">broken</span>               <span class="kt">bool</span>  <span class="c1">// an error has happened on this connection; marked broken so it&#39;s not reused.
</span><span class="c1"></span>	<span class="nx">reused</span>               <span class="kt">bool</span>  <span class="c1">// whether conn has had successful request/response and is being reused.
</span><span class="c1"></span>	<span class="c1">// mutateHeaderFunc is an optional func to modify extra
</span><span class="c1"></span>	<span class="c1">// headers on each outbound request before it&#39;s written. (the
</span><span class="c1"></span>	<span class="c1">// original Request given to RoundTrip is not modified)
</span><span class="c1"></span>	<span class="nx">mutateHeaderFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">Header</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h5 id="默认参数">默认参数<a href="#默认参数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">DefaultTransport</span> <span class="nx">RoundTripper</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Transport</span><span class="p">{</span>
	<span class="nx">Proxy</span><span class="p">:</span> <span class="nx">ProxyFromEnvironment</span><span class="p">,</span>
	<span class="nx">DialContext</span><span class="p">:</span> <span class="p">(</span><span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">{</span>
		<span class="nx">Timeout</span><span class="p">:</span>   <span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
		<span class="nx">KeepAlive</span><span class="p">:</span> <span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
		<span class="nx">DualStack</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
	<span class="p">}).</span><span class="nx">DialContext</span><span class="p">,</span>
	<span class="nx">MaxIdleConns</span><span class="p">:</span>          <span class="mi">100</span><span class="p">,</span>
	<span class="nx">IdleConnTimeout</span><span class="p">:</span>       <span class="mi">90</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
	<span class="nx">TLSHandshakeTimeout</span><span class="p">:</span>   <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
	<span class="nx">ExpectContinueTimeout</span><span class="p">:</span> <span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div><h3 id="请求">请求<a href="#请求" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<h4 id="do">Do<a href="#do" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>当我们请求一个接口的时候，我们通常使用client.Do进行调用</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Do也是直接调用do
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">do</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">retres</span> <span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">reterr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">testHookClientDoResult</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nf">testHookClientDoResult</span><span class="p">(</span><span class="nx">retres</span><span class="p">,</span> <span class="nx">reterr</span><span class="p">)</span> <span class="p">}()</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">url</span><span class="p">.</span><span class="nx">Error</span><span class="p">{</span>
			<span class="nx">Op</span><span class="p">:</span>  <span class="nf">urlErrorOp</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Method</span><span class="p">),</span>
			<span class="nx">Err</span><span class="p">:</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http: nil Request.URL&#34;</span><span class="p">),</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="p">(</span>
		<span class="nx">deadline</span>      <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">deadline</span><span class="p">()</span>
		<span class="nx">reqs</span>          <span class="p">[]</span><span class="o">*</span><span class="nx">Request</span>
		<span class="nx">resp</span>          <span class="o">*</span><span class="nx">Response</span>
		<span class="nx">copyHeaders</span>   <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">makeHeadersCopier</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
		<span class="nx">reqBodyClosed</span> <span class="p">=</span> <span class="kc">false</span> <span class="c1">// have we closed the current req.Body?
</span><span class="c1"></span>
		<span class="c1">// Redirect behavior:
</span><span class="c1"></span>		<span class="nx">redirectMethod</span> <span class="kt">string</span>
		<span class="nx">includeBody</span>    <span class="kt">bool</span>
	<span class="p">)</span>
	<span class="nx">uerr</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="c1">// the body may have been closed already by c.send()
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">reqBodyClosed</span> <span class="p">{</span>
			<span class="c1">// closeBody 其实也是调用Body.Close
</span><span class="c1"></span>			<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">urlStr</span> <span class="kt">string</span>
		<span class="k">if</span> <span class="nx">resp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Request</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">urlStr</span> <span class="p">=</span> <span class="nf">stripPassword</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">urlStr</span> <span class="p">=</span> <span class="nf">stripPassword</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">url</span><span class="p">.</span><span class="nx">Error</span><span class="p">{</span>
			<span class="nx">Op</span><span class="p">:</span>  <span class="nf">urlErrorOp</span><span class="p">(</span><span class="nx">reqs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Method</span><span class="p">),</span>
			<span class="nx">URL</span><span class="p">:</span> <span class="nx">urlStr</span><span class="p">,</span>
			<span class="nx">Err</span><span class="p">:</span> <span class="nx">err</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="c1">// For all but the first request, create the next
</span><span class="c1"></span>		<span class="c1">// request hop and replace req.
</span><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">reqs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">loc</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Location&#34;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">loc</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
				<span class="nx">resp</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">uerr</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%d response missing Location header&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">))</span>
			<span class="p">}</span>
			<span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">loc</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">resp</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">uerr</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to parse Location header %q: %v&#34;</span><span class="p">,</span> <span class="nx">loc</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
			<span class="p">}</span>
			<span class="nx">host</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
			<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Host</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Host</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Host</span> <span class="p">{</span>
				<span class="c1">// If the caller specified a custom Host header and the
</span><span class="c1"></span>				<span class="c1">// redirect location is relative, preserve the Host header
</span><span class="c1"></span>				<span class="c1">// through the redirect. See issue #22233.
</span><span class="c1"></span>				<span class="k">if</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">loc</span><span class="p">);</span> <span class="nx">u</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">u</span><span class="p">.</span><span class="nf">IsAbs</span><span class="p">()</span> <span class="p">{</span>
					<span class="nx">host</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Host</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="nx">ireq</span> <span class="o">:=</span> <span class="nx">reqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="nx">req</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Request</span><span class="p">{</span>
				<span class="nx">Method</span><span class="p">:</span>   <span class="nx">redirectMethod</span><span class="p">,</span>
				<span class="nx">Response</span><span class="p">:</span> <span class="nx">resp</span><span class="p">,</span>
				<span class="nx">URL</span><span class="p">:</span>      <span class="nx">u</span><span class="p">,</span>
				<span class="nx">Header</span><span class="p">:</span>   <span class="nb">make</span><span class="p">(</span><span class="nx">Header</span><span class="p">),</span>
				<span class="nx">Host</span><span class="p">:</span>     <span class="nx">host</span><span class="p">,</span>
				<span class="nx">Cancel</span><span class="p">:</span>   <span class="nx">ireq</span><span class="p">.</span><span class="nx">Cancel</span><span class="p">,</span>
				<span class="nx">ctx</span><span class="p">:</span>      <span class="nx">ireq</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">includeBody</span> <span class="o">&amp;&amp;</span> <span class="nx">ireq</span><span class="p">.</span><span class="nx">GetBody</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ireq</span><span class="p">.</span><span class="nf">GetBody</span><span class="p">()</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">resp</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
					<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">uerr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="nx">req</span><span class="p">.</span><span class="nx">ContentLength</span> <span class="p">=</span> <span class="nx">ireq</span><span class="p">.</span><span class="nx">ContentLength</span>
			<span class="p">}</span>

			<span class="c1">// Copy original headers before setting the Referer,
</span><span class="c1"></span>			<span class="c1">// in case the user set Referer on their first request.
</span><span class="c1"></span>			<span class="c1">// If they really want to override, they can do it in
</span><span class="c1"></span>			<span class="c1">// their CheckRedirect func.
</span><span class="c1"></span>			<span class="nf">copyHeaders</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>

			<span class="c1">// Add the Referer header from the most recent
</span><span class="c1"></span>			<span class="c1">// request URL to the new one, if it&#39;s not https-&gt;http:
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">ref</span> <span class="o">:=</span> <span class="nf">refererForURL</span><span class="p">(</span><span class="nx">reqs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">reqs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">URL</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">);</span> <span class="nx">ref</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
				<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Referer&#34;</span><span class="p">,</span> <span class="nx">ref</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">checkRedirect</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">reqs</span><span class="p">)</span>

			<span class="c1">// Sentinel error to let users select the
</span><span class="c1"></span>			<span class="c1">// previous response, without closing its
</span><span class="c1"></span>			<span class="c1">// body. See Issue 10069.
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">ErrUseLastResponse</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
			<span class="p">}</span>

			<span class="c1">// Close the previous response&#39;s body. But
</span><span class="c1"></span>			<span class="c1">// read at least some of the body so if it&#39;s
</span><span class="c1"></span>			<span class="c1">// small the underlying TCP connection will be
</span><span class="c1"></span>			<span class="c1">// re-used. No need to check for errors: if it
</span><span class="c1"></span>			<span class="c1">// fails, the Transport won&#39;t reuse it anyway.
</span><span class="c1"></span>			<span class="kd">const</span> <span class="nx">maxBodySlurpSize</span> <span class="p">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
			<span class="k">if</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">ContentLength</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">ContentLength</span> <span class="o">&lt;=</span> <span class="nx">maxBodySlurpSize</span> <span class="p">{</span>
				<span class="nx">io</span><span class="p">.</span><span class="nf">CopyN</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">Discard</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">maxBodySlurpSize</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="c1">// Special case for Go 1 compatibility: return both the response
</span><span class="c1"></span>				<span class="c1">// and an error if the CheckRedirect function failed.
</span><span class="c1"></span>				<span class="c1">// See https://golang.org/issue/3795
</span><span class="c1"></span>				<span class="c1">// The resp.Body has already been closed.
</span><span class="c1"></span>				<span class="nx">ue</span> <span class="o">:=</span> <span class="nf">uerr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
				<span class="nx">ue</span><span class="p">.(</span><span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">Error</span><span class="p">).</span><span class="nx">URL</span> <span class="p">=</span> <span class="nx">loc</span>
				<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">ue</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="nx">reqs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">reqs</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
		<span class="kd">var</span> <span class="nx">didTimeout</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">bool</span>
		<span class="k">if</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">didTimeout</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">deadline</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// c.send() always closes req.Body
</span><span class="c1"></span>			<span class="nx">reqBodyClosed</span> <span class="p">=</span> <span class="kc">true</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">deadline</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nf">didTimeout</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">err</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">httpError</span><span class="p">{</span>
					<span class="c1">// TODO: early in cycle: s/Client.Timeout exceeded/timeout or context cancelation/
</span><span class="c1"></span>					<span class="nx">err</span><span class="p">:</span>     <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34; (Client.Timeout exceeded while awaiting headers)&#34;</span><span class="p">,</span>
					<span class="nx">timeout</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">uerr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">shouldRedirect</span> <span class="kt">bool</span>
		<span class="nx">redirectMethod</span><span class="p">,</span> <span class="nx">shouldRedirect</span><span class="p">,</span> <span class="nx">includeBody</span> <span class="p">=</span> <span class="nf">redirectBehavior</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">reqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">shouldRedirect</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>

		<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h4 id="clientsend">client.send<a href="#clientsend" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">send</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">deadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">didTimeout</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Jar</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cookie</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Jar</span><span class="p">.</span><span class="nf">Cookies</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">req</span><span class="p">.</span><span class="nf">AddCookie</span><span class="p">(</span><span class="nx">cookie</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">didTimeout</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">send</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nf">transport</span><span class="p">(),</span> <span class="nx">deadline</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">didTimeout</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Jar</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">rc</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">Cookies</span><span class="p">();</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rc</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nx">Jar</span><span class="p">.</span><span class="nf">SetCookies</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span> <span class="nx">rc</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><h4 id="send">send<a href="#send" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>发送HTTP请求</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nx">ireq</span> <span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">rt</span> <span class="nx">RoundTripper</span><span class="p">,</span> <span class="nx">deadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">didTimeout</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">ireq</span> <span class="c1">// req is either the original request, or a modified fork
</span><span class="c1"></span>
	<span class="k">if</span> <span class="nx">rt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">alwaysFalse</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http: no Client.Transport or DefaultTransport&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">alwaysFalse</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http: nil Request.URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">RequestURI</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">alwaysFalse</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http: Request.RequestURI can&#39;t be set in client requests.&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// forkReq forks req into a shallow clone of ireq the first
</span><span class="c1"></span>	<span class="c1">// time it&#39;s called.
</span><span class="c1"></span>	<span class="nx">forkReq</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">ireq</span> <span class="o">==</span> <span class="nx">req</span> <span class="p">{</span>
			<span class="nx">req</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Request</span><span class="p">)</span>
			<span class="o">*</span><span class="nx">req</span> <span class="p">=</span> <span class="o">*</span><span class="nx">ireq</span> <span class="c1">// shallow clone
</span><span class="c1"></span>		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// Most the callers of send (Get, Post, et al) don&#39;t need
</span><span class="c1"></span>	<span class="c1">// Headers, leaving it uninitialized. We guarantee to the
</span><span class="c1"></span>	<span class="c1">// Transport that this has been initialized, though.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">forkReq</span><span class="p">()</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">Header</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">u</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">User</span><span class="p">;</span> <span class="nx">u</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">username</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nf">Username</span><span class="p">()</span>
		<span class="nx">password</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nf">Password</span><span class="p">()</span>
		<span class="nf">forkReq</span><span class="p">()</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span> <span class="p">=</span> <span class="nx">ireq</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">,</span> <span class="s">&#34;Basic &#34;</span><span class="o">+</span><span class="nf">basicAuth</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">deadline</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
		<span class="nf">forkReq</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="nx">stopTimer</span><span class="p">,</span> <span class="nx">didTimeout</span> <span class="o">:=</span> <span class="nf">setRequestCancel</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">rt</span><span class="p">,</span> <span class="nx">deadline</span><span class="p">)</span>
	<span class="c1">// 处理 req
</span><span class="c1"></span>	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">stopTimer</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">resp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;RoundTripper returned a response &amp; error; ignoring response&#34;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">tlsErr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">tls</span><span class="p">.</span><span class="nx">RecordHeaderError</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="c1">// If we get a bad TLS record header, check to see if the
</span><span class="c1"></span>			<span class="c1">// response looks like HTTP and give a more helpful error.
</span><span class="c1"></span>			<span class="c1">// See golang.org/issue/11111.
</span><span class="c1"></span>			<span class="k">if</span> <span class="nb">string</span><span class="p">(</span><span class="nx">tlsErr</span><span class="p">.</span><span class="nx">RecordHeader</span><span class="p">[:])</span> <span class="o">==</span> <span class="s">&#34;HTTP/&#34;</span> <span class="p">{</span>
				<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http: server gave HTTP response to HTTPS client&#34;</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">didTimeout</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">deadline</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cancelTimerBody</span><span class="p">{</span>
			<span class="nx">stop</span><span class="p">:</span>          <span class="nx">stopTimer</span><span class="p">,</span>
			<span class="nx">rc</span><span class="p">:</span>            <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span>
			<span class="nx">reqDidTimeout</span><span class="p">:</span> <span class="nx">didTimeout</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><h4 id="roundtrip">roundTrip<a href="#roundtrip" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>roundTrip实现了HTTP的RoundTripper</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">roundTrip</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">.</span><span class="nx">nextProtoOnce</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">onceSetNextProtoDefaults</span><span class="p">)</span>
	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
	<span class="nx">trace</span> <span class="o">:=</span> <span class="nx">httptrace</span><span class="p">.</span><span class="nf">ContextClientTrace</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http: nil Request.URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http: nil Request.Header&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">scheme</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Scheme</span>
	<span class="nx">isHTTP</span> <span class="o">:=</span> <span class="nx">scheme</span> <span class="o">==</span> <span class="s">&#34;http&#34;</span> <span class="o">||</span> <span class="nx">scheme</span> <span class="o">==</span> <span class="s">&#34;https&#34;</span>
	<span class="k">if</span> <span class="nx">isHTTP</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">vv</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">httpguts</span><span class="p">.</span><span class="nf">ValidHeaderFieldName</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;net/http: invalid header field name %q&#34;</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">vv</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">!</span><span class="nx">httpguts</span><span class="p">.</span><span class="nf">ValidHeaderFieldValue</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;net/http: invalid header field value %q for key %v&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">useRegisteredProtocol</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">altProto</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">altProto</span><span class="p">.</span><span class="nf">Load</span><span class="p">().(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">RoundTripper</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">altRT</span> <span class="o">:=</span> <span class="nx">altProto</span><span class="p">[</span><span class="nx">scheme</span><span class="p">];</span> <span class="nx">altRT</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">altRT</span><span class="p">.</span><span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">ErrSkipAltProtocol</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">isHTTP</span> <span class="p">{</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">badStringError</span><span class="p">{</span><span class="s">&#34;unsupported protocol scheme&#34;</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nf">validMethod</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Method</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;net/http: invalid method %q&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Host</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http: no Host in request URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
			<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
		<span class="k">default</span><span class="p">:</span>
		<span class="p">}</span>

		<span class="c1">// treq gets modified by roundTrip, so we need to recreate for each retry.
</span><span class="c1"></span>		<span class="nx">treq</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">transportRequest</span><span class="p">{</span><span class="nx">Request</span><span class="p">:</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">trace</span><span class="p">:</span> <span class="nx">trace</span><span class="p">}</span>
		<span class="nx">cm</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">connectMethodForRequest</span><span class="p">(</span><span class="nx">treq</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>

        <span class="c1">// 获取一个连接从缓存或者是新建
</span><span class="c1"></span>		<span class="nx">pconn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">getConn</span><span class="p">(</span><span class="nx">treq</span><span class="p">,</span> <span class="nx">cm</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
			<span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span>
		<span class="k">if</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">alt</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// HTTP/2 path.
</span><span class="c1"></span>			<span class="nx">t</span><span class="p">.</span><span class="nf">decHostConnCount</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nf">key</span><span class="p">())</span> <span class="c1">// don&#39;t count cached http2 conns toward conns per host
</span><span class="c1"></span>			<span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>   <span class="c1">// not cancelable with CancelRequest
</span><span class="c1"></span>			<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">alt</span><span class="p">.</span><span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="c1">// 处理req和resp
</span><span class="c1"></span>			<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">roundTrip</span><span class="p">(</span><span class="nx">treq</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">pconn</span><span class="p">.</span><span class="nf">shouldRetryRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">// Issue 16465: return underlying net.Conn.Read error from peek,
</span><span class="c1"></span>			<span class="c1">// as we&#39;ve historically done.
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">transportReadFromServerError</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
				<span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">err</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="nf">testHookRoundTripRetried</span><span class="p">()</span>

		<span class="c1">// Rewind the body if we&#39;re able to.
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">GetBody</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">newReq</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">req</span>
			<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
			<span class="nx">newReq</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">GetBody</span><span class="p">()</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
			<span class="p">}</span>
			<span class="nx">req</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">newReq</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h4 id="getconn">getConn<a href="#getconn" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>getConn获取一个连接</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">getConn</span><span class="p">(</span><span class="nx">treq</span> <span class="o">*</span><span class="nx">transportRequest</span><span class="p">,</span> <span class="nx">cm</span> <span class="nx">connectMethod</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">persistConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">treq</span><span class="p">.</span><span class="nx">Request</span>
	<span class="nx">trace</span> <span class="o">:=</span> <span class="nx">treq</span><span class="p">.</span><span class="nx">trace</span>
	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">GetConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">trace</span><span class="p">.</span><span class="nf">GetConn</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nf">addr</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="c1">// 获取空闲连接
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">pc</span><span class="p">,</span> <span class="nx">idleSince</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">getIdleConn</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span> <span class="nx">pc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">GotConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">trace</span><span class="p">.</span><span class="nf">GotConn</span><span class="p">(</span><span class="nx">pc</span><span class="p">.</span><span class="nf">gotIdleConnTrace</span><span class="p">(</span><span class="nx">idleSince</span><span class="p">))</span>
		<span class="p">}</span>
		<span class="c1">// set request canceler to some non-nil function so we
</span><span class="c1"></span>		<span class="c1">// can detect whether it was cleared between now and when
</span><span class="c1"></span>		<span class="c1">// we enter roundTrip
</span><span class="c1"></span>		<span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span> <span class="p">{})</span>
		<span class="k">return</span> <span class="nx">pc</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="kd">type</span> <span class="nx">dialRes</span> <span class="kd">struct</span> <span class="p">{</span>
		<span class="nx">pc</span>  <span class="o">*</span><span class="nx">persistConn</span>
		<span class="nx">err</span> <span class="kt">error</span>
	<span class="p">}</span>
	<span class="nx">dialc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">dialRes</span><span class="p">)</span>
	<span class="nx">cmKey</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">key</span><span class="p">()</span>

	<span class="c1">// Copy these hooks so we don&#39;t race on the postPendingDial in
</span><span class="c1"></span>	<span class="c1">// the goroutine we launch. Issue 11136.
</span><span class="c1"></span>	<span class="nx">testHookPrePendingDial</span> <span class="o">:=</span> <span class="nx">testHookPrePendingDial</span>
	<span class="nx">testHookPostPendingDial</span> <span class="o">:=</span> <span class="nx">testHookPostPendingDial</span>

	<span class="nx">handlePendingDial</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nf">testHookPrePendingDial</span><span class="p">()</span>
		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">v</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">dialc</span><span class="p">;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">t</span><span class="p">.</span><span class="nf">putOrCloseIdleConn</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">pc</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">t</span><span class="p">.</span><span class="nf">decHostConnCount</span><span class="p">(</span><span class="nx">cmKey</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nf">testHookPostPendingDial</span><span class="p">()</span>
		<span class="p">}()</span>
	<span class="p">}</span>

	<span class="nx">cancelc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> <span class="nx">cancelc</span> <span class="o">&lt;-</span> <span class="nx">err</span> <span class="p">})</span>
	<span class="c1">// 如果连接超过每个host最大允许连接，则阻塞的获取连接
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">MaxConnsPerHost</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">t</span><span class="p">.</span><span class="nf">incHostConnCount</span><span class="p">(</span><span class="nx">cmKey</span><span class="p">):</span>
			<span class="c1">// 判断每个host最大连接有没有设置或者有没有超过限制，如果都没满足，则继续
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">pc</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">t</span><span class="p">.</span><span class="nf">getIdleConnCh</span><span class="p">(</span><span class="nx">cm</span><span class="p">):</span>
			<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">GotConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">trace</span><span class="p">.</span><span class="nf">GotConn</span><span class="p">(</span><span class="nx">httptrace</span><span class="p">.</span><span class="nx">GotConnInfo</span><span class="p">{</span><span class="nx">Conn</span><span class="p">:</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">Reused</span><span class="p">:</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">isReused</span><span class="p">()})</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nx">pc</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">req</span><span class="p">.</span><span class="nx">Cancel</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errRequestCanceledConn</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Done</span><span class="p">():</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Err</span><span class="p">()</span>
		<span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">cancelc</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">errRequestCanceled</span> <span class="p">{</span>
				<span class="nx">err</span> <span class="p">=</span> <span class="nx">errRequestCanceledConn</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="p">}</span>

    <span class="c1">// 没有空闲的连接，需要新建
</span><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">pc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">dialConn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cm</span><span class="p">)</span>
		<span class="nx">dialc</span> <span class="o">&lt;-</span> <span class="nx">dialRes</span><span class="p">{</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">err</span><span class="p">}</span>
	<span class="p">}()</span>

	<span class="nx">idleConnCh</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">getIdleConnCh</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span>
	<span class="k">select</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">v</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">dialc</span><span class="p">:</span>
		<span class="c1">// Our dial finished.
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nx">pc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">GotConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">alt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">trace</span><span class="p">.</span><span class="nf">GotConn</span><span class="p">(</span><span class="nx">httptrace</span><span class="p">.</span><span class="nx">GotConnInfo</span><span class="p">{</span><span class="nx">Conn</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">conn</span><span class="p">})</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">pc</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="c1">// Our dial failed. See why to return a nicer error
</span><span class="c1"></span>		<span class="c1">// value.
</span><span class="c1"></span>		<span class="nx">t</span><span class="p">.</span><span class="nf">decHostConnCount</span><span class="p">(</span><span class="nx">cmKey</span><span class="p">)</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">req</span><span class="p">.</span><span class="nx">Cancel</span><span class="p">:</span>
			<span class="c1">// It was an error due to cancelation, so prioritize that
</span><span class="c1"></span>			<span class="c1">// error value. (Issue 16049)
</span><span class="c1"></span>			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errRequestCanceledConn</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Done</span><span class="p">():</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Err</span><span class="p">()</span>
		<span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">cancelc</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">errRequestCanceled</span> <span class="p">{</span>
				<span class="nx">err</span> <span class="p">=</span> <span class="nx">errRequestCanceledConn</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="c1">// It wasn&#39;t an error due to cancelation, so
</span><span class="c1"></span>			<span class="c1">// return the original error message:
</span><span class="c1"></span>			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">err</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="nx">pc</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">idleConnCh</span><span class="p">:</span>
		<span class="c1">// Another request finished first and its net.Conn
</span><span class="c1"></span>		<span class="c1">// became available before our dial. Or somebody
</span><span class="c1"></span>		<span class="c1">// else&#39;s dial that they didn&#39;t use.
</span><span class="c1"></span>		<span class="c1">// But our dial is still going, so give it away
</span><span class="c1"></span>		<span class="c1">// when it finishes:
</span><span class="c1"></span>		<span class="nf">handlePendingDial</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">GotConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">trace</span><span class="p">.</span><span class="nf">GotConn</span><span class="p">(</span><span class="nx">httptrace</span><span class="p">.</span><span class="nx">GotConnInfo</span><span class="p">{</span><span class="nx">Conn</span><span class="p">:</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">Reused</span><span class="p">:</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">isReused</span><span class="p">()})</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">pc</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">req</span><span class="p">.</span><span class="nx">Cancel</span><span class="p">:</span>
		<span class="nf">handlePendingDial</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errRequestCanceledConn</span>
	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Done</span><span class="p">():</span>
		<span class="nf">handlePendingDial</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Err</span><span class="p">()</span>
	<span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">cancelc</span><span class="p">:</span>
		<span class="nf">handlePendingDial</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">errRequestCanceled</span> <span class="p">{</span>
			<span class="nx">err</span> <span class="p">=</span> <span class="nx">errRequestCanceledConn</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></div><h4 id="getidleconn">getIdleConn<a href="#getidleconn" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>获取空闲的连接</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">getIdleConn</span><span class="p">(</span><span class="nx">cm</span> <span class="nx">connectMethod</span><span class="p">)</span> <span class="p">(</span><span class="nx">pconn</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">,</span> <span class="nx">idleSince</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">key</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">key</span><span class="p">()</span>
	<span class="nx">t</span><span class="p">.</span><span class="nx">idleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">t</span><span class="p">.</span><span class="nx">idleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">for</span> <span class="p">{</span>
        <span class="c1">// 从idleConn获取空闲连接
</span><span class="c1"></span>		<span class="nx">pconns</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">idleConn</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">{}</span>
        <span class="p">}</span>
        <span class="c1">// 只有一个空闲连接
</span><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pconns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
			<span class="nx">pconn</span> <span class="p">=</span> <span class="nx">pconns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="nb">delete</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">idleConn</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// 有2个或者2个以上空闲连接，用最近的的
</span><span class="c1"></span>			<span class="nx">pconn</span> <span class="p">=</span> <span class="nx">pconns</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">pconns</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="nx">t</span><span class="p">.</span><span class="nx">idleConn</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">pconns</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">pconns</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="p">}</span>
		<span class="c1">// 从idle cache中删除该连接
</span><span class="c1"></span>        <span class="nx">t</span><span class="p">.</span><span class="nx">idleLRU</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="nx">pconn</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">isBroken</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// 有小概率，连接已消亡和removeIdleConn
</span><span class="c1"></span>			<span class="c1">// There is a tiny window where this is
</span><span class="c1"></span>			<span class="c1">// possible, between the connecting dying and
</span><span class="c1"></span>			<span class="c1">// the persistConn readLoop calling
</span><span class="c1"></span>			<span class="c1">// Transport.removeIdleConn. Just skip it and
</span><span class="c1"></span>			<span class="c1">// carry on.
</span><span class="c1"></span>			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">pconn</span><span class="p">,</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">idleAt</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></div><h4 id="getidleconnch">getIdleConnCh<a href="#getidleconnch" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>getIdleConnCh返回一个chan用来接收persistConn，如果没有使用持久连接，会返回nil</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">getIdleConnCh</span><span class="p">(</span><span class="nx">cm</span> <span class="nx">connectMethod</span><span class="p">)</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">persistConn</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">DisableKeepAlives</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="nx">key</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">key</span><span class="p">()</span>
	<span class="nx">t</span><span class="p">.</span><span class="nx">idleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">t</span><span class="p">.</span><span class="nx">idleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="nx">t</span><span class="p">.</span><span class="nx">wantIdle</span> <span class="p">=</span> <span class="kc">false</span>
	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">idleConnCh</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nx">idleConnCh</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">connectMethodKey</span><span class="p">]</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">ch</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">idleConnCh</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">ch</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span>
		<span class="nx">t</span><span class="p">.</span><span class="nx">idleConnCh</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">ch</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span>

</code></pre></div><h4 id="dialconn">dialConn<a href="#dialconn" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>新建连接</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">dialConn</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">cm</span> <span class="nx">connectMethod</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">persistConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 新建persistConn
</span><span class="c1"></span>	<span class="nx">pconn</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">persistConn</span><span class="p">{</span>
		<span class="nx">t</span><span class="p">:</span>             <span class="nx">t</span><span class="p">,</span>
		<span class="nx">cacheKey</span><span class="p">:</span>      <span class="nx">cm</span><span class="p">.</span><span class="nf">key</span><span class="p">(),</span>
		<span class="nx">reqch</span><span class="p">:</span>         <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">requestAndChan</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		<span class="nx">writech</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">writeRequest</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		<span class="nx">closech</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
		<span class="nx">writeErrCh</span><span class="p">:</span>    <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		<span class="nx">writeLoopDone</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
	<span class="p">}</span>
	<span class="nx">trace</span> <span class="o">:=</span> <span class="nx">httptrace</span><span class="p">.</span><span class="nf">ContextClientTrace</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">wrapErr</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">proxyURL</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// Return a typed error, per Issue 16997
</span><span class="c1"></span>			<span class="k">return</span> <span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">OpError</span><span class="p">{</span><span class="nx">Op</span><span class="p">:</span> <span class="s">&#34;proxyconnect&#34;</span><span class="p">,</span> <span class="nx">Net</span><span class="p">:</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">Err</span><span class="p">:</span> <span class="nx">err</span><span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">scheme</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;https&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">DialTLS</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
		<span class="nx">pconn</span><span class="p">.</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">DialTLS</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">addr</span><span class="p">())</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">wrapErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">conn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">wrapErr</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;net/http: Transport.DialTLS returned (nil, nil)&#34;</span><span class="p">))</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">tc</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">conn</span><span class="p">.(</span><span class="o">*</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Conn</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="c1">// Handshake here, in case DialTLS didn&#39;t. TLSNextProto below
</span><span class="c1"></span>			<span class="c1">// depends on it for knowing the connection state.
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">TLSHandshakeStart</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">trace</span><span class="p">.</span><span class="nf">TLSHandshakeStart</span><span class="p">()</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nf">Handshake</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">go</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
				<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">TLSHandshakeDone</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">trace</span><span class="p">.</span><span class="nf">TLSHandshakeDone</span><span class="p">(</span><span class="nx">tls</span><span class="p">.</span><span class="nx">ConnectionState</span><span class="p">{},</span> <span class="nx">err</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
			<span class="p">}</span>
			<span class="nx">cs</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nf">ConnectionState</span><span class="p">()</span>
			<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">TLSHandshakeDone</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">trace</span><span class="p">.</span><span class="nf">TLSHandshakeDone</span><span class="p">(</span><span class="nx">cs</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">pconn</span><span class="p">.</span><span class="nx">tlsState</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cs</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="c1">// 新建连接
</span><span class="c1"></span>		<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">dial</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">addr</span><span class="p">())</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">wrapErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">pconn</span><span class="p">.</span><span class="nx">conn</span> <span class="p">=</span> <span class="nx">conn</span>
		<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">scheme</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;https&#34;</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">firstTLSHost</span> <span class="kt">string</span>
			<span class="k">if</span> <span class="nx">firstTLSHost</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">SplitHostPort</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nf">addr</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">wrapErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">addTLS</span><span class="p">(</span><span class="nx">firstTLSHost</span><span class="p">,</span> <span class="nx">trace</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">wrapErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// Proxy setup.
</span><span class="c1"></span>	<span class="c1">// 忽略...
</span><span class="c1"></span>
	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">MaxConnsPerHost</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// 封装连接·
</span><span class="c1"></span>		<span class="nx">pconn</span><span class="p">.</span><span class="nx">conn</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">connCloseListener</span><span class="p">{</span><span class="nx">Conn</span><span class="p">:</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">t</span><span class="p">:</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">cmKey</span><span class="p">:</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">cacheKey</span><span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">pconn</span><span class="p">.</span><span class="nx">br</span> <span class="p">=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">pconn</span><span class="p">)</span>
    <span class="nx">pconn</span><span class="p">.</span><span class="nx">bw</span> <span class="p">=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="nx">persistConnWriter</span><span class="p">{</span><span class="nx">pconn</span><span class="p">})</span>
    <span class="c1">// 开启两个loop
</span><span class="c1"></span>	<span class="k">go</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">readLoop</span><span class="p">()</span>
	<span class="k">go</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">writeLoop</span><span class="p">()</span>
	<span class="k">return</span> <span class="nx">pconn</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

</code></pre></div><h4 id="persistconnroundtrip">persistConn.roundTrip<a href="#persistconnroundtrip" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>roundTrip处理往返的数据，和readLoop、writeLoop进行交互</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span> <span class="nf">roundTrip</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">transportRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">testHookEnterRoundTrip</span><span class="p">()</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">replaceReqCanceler</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">cancelRequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">putOrCloseIdleConn</span><span class="p">(</span><span class="nx">pc</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errRequestCanceled</span>
	<span class="p">}</span>
	<span class="nx">pc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="nx">pc</span><span class="p">.</span><span class="nx">numExpectedResponses</span><span class="o">++</span>
	<span class="nx">headerFn</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">mutateHeaderFunc</span>
	<span class="nx">pc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">headerFn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">headerFn</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nf">extraHeaders</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="c1">// Ask for a compressed version if the caller didn&#39;t set their
</span><span class="c1"></span>	<span class="c1">// own value for Accept-Encoding. We only attempt to
</span><span class="c1"></span>	<span class="c1">// uncompress the gzip stream if we were the layer that
</span><span class="c1"></span>	<span class="c1">// requested it.
</span><span class="c1"></span>	<span class="nx">requestedGzip</span> <span class="o">:=</span> <span class="kc">false</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nx">DisableCompression</span> <span class="o">&amp;&amp;</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Range&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">!=</span> <span class="s">&#34;HEAD&#34;</span> <span class="p">{</span>
		<span class="c1">// Request gzip only, not deflate. Deflate is ambiguous and
</span><span class="c1"></span>		<span class="c1">// not as universally supported anyway.
</span><span class="c1"></span>		<span class="c1">// See: https://zlib.net/zlib_faq.html#faq39
</span><span class="c1"></span>		<span class="c1">//
</span><span class="c1"></span>		<span class="c1">// Note that we don&#39;t request this for HEAD requests,
</span><span class="c1"></span>		<span class="c1">// due to a bug in nginx:
</span><span class="c1"></span>		<span class="c1">//   https://trac.nginx.org/nginx/ticket/358
</span><span class="c1"></span>		<span class="c1">//   https://golang.org/issue/5522
</span><span class="c1"></span>		<span class="c1">//
</span><span class="c1"></span>		<span class="c1">// We don&#39;t request gzip if the request is for a range, since
</span><span class="c1"></span>		<span class="c1">// auto-decoding a portion of a gzipped document will just fail
</span><span class="c1"></span>		<span class="c1">// anyway. See https://golang.org/issue/8923
</span><span class="c1"></span>		<span class="nx">requestedGzip</span> <span class="p">=</span> <span class="kc">true</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">extraHeaders</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">continueCh</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nf">ProtoAtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Body</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nf">expectsContinue</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">continueCh</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nx">DisableKeepAlives</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">req</span><span class="p">.</span><span class="nf">wantsClose</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">extraHeaders</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Connection&#34;</span><span class="p">,</span> <span class="s">&#34;close&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">gone</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">gone</span><span class="p">)</span>

	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}()</span>

	<span class="kd">const</span> <span class="nx">debugRoundTrip</span> <span class="p">=</span> <span class="kc">false</span>

	<span class="c1">// Write the request concurrently with waiting for a response,
</span><span class="c1"></span>	<span class="c1">// in case the server decides to reply before reading our full
</span><span class="c1"></span>	<span class="c1">// request body.
</span><span class="c1"></span>	<span class="nx">startBytesWritten</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">nwrite</span>
	<span class="nx">writeErrCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="c1">// 将请求写入writech，有writeLoop
</span><span class="c1"></span>	<span class="nx">pc</span><span class="p">.</span><span class="nx">writech</span> <span class="o">&lt;-</span> <span class="nx">writeRequest</span><span class="p">{</span><span class="nx">req</span><span class="p">,</span> <span class="nx">writeErrCh</span><span class="p">,</span> <span class="nx">continueCh</span><span class="p">}</span>

	<span class="nx">resc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">responseAndError</span><span class="p">)</span>
	<span class="c1">// 写入reqch， 由readLoop读取
</span><span class="c1"></span>	<span class="nx">pc</span><span class="p">.</span><span class="nx">reqch</span> <span class="o">&lt;-</span> <span class="nx">requestAndChan</span><span class="p">{</span>
		<span class="nx">req</span><span class="p">:</span>        <span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
		<span class="nx">ch</span><span class="p">:</span>         <span class="nx">resc</span><span class="p">,</span>
		<span class="nx">addedGzip</span><span class="p">:</span>  <span class="nx">requestedGzip</span><span class="p">,</span>
		<span class="nx">continueCh</span><span class="p">:</span> <span class="nx">continueCh</span><span class="p">,</span>
		<span class="nx">callerGone</span><span class="p">:</span> <span class="nx">gone</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">respHeaderTimer</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
	<span class="nx">cancelChan</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Cancel</span>
	<span class="nx">ctxDoneChan</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Done</span><span class="p">()</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nf">testHookWaitResLoop</span><span class="p">()</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">writeErrCh</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">debugRoundTrip</span> <span class="p">{</span>
				<span class="nx">req</span><span class="p">.</span><span class="nf">logf</span><span class="p">(</span><span class="s">&#34;writeErrCh resv: %T/%#v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">pc</span><span class="p">.</span><span class="nb">close</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;write error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">mapRoundTripError</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">startBytesWritten</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">d</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nx">ResponseHeaderTimeout</span><span class="p">;</span> <span class="nx">d</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">debugRoundTrip</span> <span class="p">{</span>
					<span class="nx">req</span><span class="p">.</span><span class="nf">logf</span><span class="p">(</span><span class="s">&#34;starting timer for %v&#34;</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="nx">timer</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
				<span class="k">defer</span> <span class="nx">timer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span> <span class="c1">// prevent leaks
</span><span class="c1"></span>				<span class="nx">respHeaderTimer</span> <span class="p">=</span> <span class="nx">timer</span><span class="p">.</span><span class="nx">C</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">pc</span><span class="p">.</span><span class="nx">closech</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">debugRoundTrip</span> <span class="p">{</span>
				<span class="nx">req</span><span class="p">.</span><span class="nf">logf</span><span class="p">(</span><span class="s">&#34;closech recv: %T %#v&#34;</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">closed</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">closed</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">mapRoundTripError</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">startBytesWritten</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">closed</span><span class="p">)</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">respHeaderTimer</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">debugRoundTrip</span> <span class="p">{</span>
				<span class="nx">req</span><span class="p">.</span><span class="nf">logf</span><span class="p">(</span><span class="s">&#34;timeout waiting for response headers.&#34;</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nb">close</span><span class="p">(</span><span class="nx">errTimeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errTimeout</span>
		<span class="k">case</span> <span class="nx">re</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">resc</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">re</span><span class="p">.</span><span class="nx">res</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="nx">re</span><span class="p">.</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
				<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;internal error: exactly one of res or err should be set; nil=%v&#34;</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">res</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">))</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">debugRoundTrip</span> <span class="p">{</span>
				<span class="nx">req</span><span class="p">.</span><span class="nf">logf</span><span class="p">(</span><span class="s">&#34;resc recv: %p, %T/%#v&#34;</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">res</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">err</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">re</span><span class="p">.</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">mapRoundTripError</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">startBytesWritten</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nx">re</span><span class="p">.</span><span class="nx">res</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">cancelChan</span><span class="p">:</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">CancelRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
			<span class="nx">cancelChan</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctxDoneChan</span><span class="p">:</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">cancelRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Err</span><span class="p">())</span>
			<span class="nx">cancelChan</span> <span class="p">=</span> <span class="kc">nil</span>
			<span class="nx">ctxDoneChan</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h4 id="readloop">readLoop<a href="#readloop" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span> <span class="nf">readLoop</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">closeErr</span> <span class="o">:=</span> <span class="nx">errReadLoopExiting</span> <span class="c1">// default value, if not changed below
</span><span class="c1"></span>	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nb">close</span><span class="p">(</span><span class="nx">closeErr</span><span class="p">)</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">removeIdleConn</span><span class="p">(</span><span class="nx">pc</span><span class="p">)</span>
	<span class="p">}()</span>

    <span class="c1">// 将空闲连接放入到idleConn
</span><span class="c1"></span>	<span class="nx">tryPutIdleConn</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">trace</span> <span class="o">*</span><span class="nx">httptrace</span><span class="p">.</span><span class="nx">ClientTrace</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">tryPutIdleConn</span><span class="p">(</span><span class="nx">pc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">closeErr</span> <span class="p">=</span> <span class="nx">err</span>
			<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">PutIdleConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">errKeepAlivesDisabled</span> <span class="p">{</span>
				<span class="nx">trace</span><span class="p">.</span><span class="nf">PutIdleConn</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">PutIdleConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">trace</span><span class="p">.</span><span class="nf">PutIdleConn</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">}</span>

	<span class="c1">// eofc is used to block caller goroutines reading from Response.Body
</span><span class="c1"></span>	<span class="c1">// at EOF until this goroutines has (potentially) added the connection
</span><span class="c1"></span>	<span class="c1">// back to the idle pool.
</span><span class="c1"></span>	<span class="c1">// eofc是个无缓存的chan
</span><span class="c1"></span>	<span class="nx">eofc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">eofc</span><span class="p">)</span> <span class="c1">// unblock reader on errors
</span><span class="c1"></span>
	<span class="c1">// Read this once, before loop starts. (to avoid races in tests)
</span><span class="c1"></span>	<span class="nx">testHookMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="nx">testHookReadLoopBeforeNextRead</span> <span class="o">:=</span> <span class="nx">testHookReadLoopBeforeNextRead</span>
	<span class="nx">testHookMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="nx">alive</span> <span class="o">:=</span> <span class="kc">true</span>
	<span class="k">for</span> <span class="nx">alive</span> <span class="p">{</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">readLimit</span> <span class="p">=</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">maxHeaderResponseSize</span><span class="p">()</span>
		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">br</span><span class="p">.</span><span class="nf">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

		<span class="nx">pc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">numExpectedResponses</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nf">readLoopPeekFailLocked</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

		<span class="nx">rc</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">pc</span><span class="p">.</span><span class="nx">reqch</span>
		<span class="nx">trace</span> <span class="o">:=</span> <span class="nx">httptrace</span><span class="p">.</span><span class="nf">ContextClientTrace</span><span class="p">(</span><span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">())</span>

		<span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">readResponse</span><span class="p">(</span><span class="nx">rc</span><span class="p">,</span> <span class="nx">trace</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">err</span> <span class="p">=</span> <span class="nx">transportReadFromServerError</span><span class="p">{</span><span class="nx">err</span><span class="p">}</span>
			<span class="nx">closeErr</span> <span class="p">=</span> <span class="nx">err</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">readLimit</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;net/http: server response headers exceeded %d bytes; aborted&#34;</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">maxHeaderResponseSize</span><span class="p">())</span>
			<span class="p">}</span>

			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">responseAndError</span><span class="p">{</span><span class="nx">err</span><span class="p">:</span> <span class="nx">err</span><span class="p">}:</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">rc</span><span class="p">.</span><span class="nx">callerGone</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">readLimit</span> <span class="p">=</span> <span class="nx">maxInt64</span> <span class="c1">// effictively no limit for response bodies
</span><span class="c1"></span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">numExpectedResponses</span><span class="o">--</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

		<span class="nx">bodyWritable</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">bodyIsWritable</span><span class="p">()</span>
		<span class="nx">hasBody</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">!=</span> <span class="s">&#34;HEAD&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">ContentLength</span> <span class="o">!=</span> <span class="mi">0</span>

		<span class="k">if</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Close</span> <span class="o">||</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">Close</span> <span class="o">||</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">&lt;=</span> <span class="mi">199</span> <span class="o">||</span> <span class="nx">bodyWritable</span> <span class="p">{</span>
			<span class="c1">// Don&#39;t do keep-alive on error if either party requested a close
</span><span class="c1"></span>			<span class="c1">// or we get an unexpected informational (1xx) response.
</span><span class="c1"></span>			<span class="c1">// StatusCode 100 is already handled above.
</span><span class="c1"></span>			<span class="nx">alive</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">!</span><span class="nx">hasBody</span> <span class="o">||</span> <span class="nx">bodyWritable</span> <span class="p">{</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>

			<span class="c1">// Put the idle conn back into the pool before we send the response
</span><span class="c1"></span>			<span class="c1">// so if they process it quickly and make another request, they&#39;ll
</span><span class="c1"></span>			<span class="c1">// get this same conn. But we use the unbuffered channel &#39;rc&#39;
</span><span class="c1"></span>			<span class="c1">// to guarantee that persistConn.roundTrip got out of its select
</span><span class="c1"></span>			<span class="c1">// potentially waiting for this persistConn to close.
</span><span class="c1"></span>			<span class="c1">// but after
</span><span class="c1"></span>			<span class="nx">alive</span> <span class="p">=</span> <span class="nx">alive</span> <span class="o">&amp;&amp;</span>
				<span class="p">!</span><span class="nx">pc</span><span class="p">.</span><span class="nx">sawEOF</span> <span class="o">&amp;&amp;</span>
				<span class="nx">pc</span><span class="p">.</span><span class="nf">wroteRequest</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
				<span class="nf">tryPutIdleConn</span><span class="p">(</span><span class="nx">trace</span><span class="p">)</span>

			<span class="k">if</span> <span class="nx">bodyWritable</span> <span class="p">{</span>
				<span class="nx">closeErr</span> <span class="p">=</span> <span class="nx">errCallerOwnsConn</span>
			<span class="p">}</span>

			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">responseAndError</span><span class="p">{</span><span class="nx">res</span><span class="p">:</span> <span class="nx">resp</span><span class="p">}:</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">rc</span><span class="p">.</span><span class="nx">callerGone</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="p">}</span>

			<span class="c1">// Now that they&#39;ve read from the unbuffered channel, they&#39;re safely
</span><span class="c1"></span>			<span class="c1">// out of the select that also waits on this goroutine to die, so
</span><span class="c1"></span>			<span class="c1">// we&#39;re allowed to exit now if needed (if alive is false)
</span><span class="c1"></span>			<span class="nf">testHookReadLoopBeforeNextRead</span><span class="p">()</span>
			<span class="k">continue</span>
		<span class="p">}</span>

		<span class="nx">waitForBodyRead</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
		<span class="nx">body</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">bodyEOFSignal</span><span class="p">{</span>
			<span class="nx">body</span><span class="p">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span>
			<span class="nx">earlyCloseFn</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
				<span class="nx">waitForBodyRead</span> <span class="o">&lt;-</span> <span class="kc">false</span>
				<span class="o">&lt;-</span><span class="nx">eofc</span> <span class="c1">// will be closed by deferred call at the end of the function
</span><span class="c1"></span>				<span class="k">return</span> <span class="kc">nil</span>

			<span class="p">},</span>
			<span class="nx">fn</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
				<span class="nx">isEOF</span> <span class="o">:=</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
				<span class="nx">waitForBodyRead</span> <span class="o">&lt;-</span> <span class="nx">isEOF</span>
				<span class="k">if</span> <span class="nx">isEOF</span> <span class="p">{</span>
					<span class="o">&lt;-</span><span class="nx">eofc</span> <span class="c1">// see comment above eofc declaration
</span><span class="c1"></span>				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="k">if</span> <span class="nx">cerr</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">canceled</span><span class="p">();</span> <span class="nx">cerr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
						<span class="k">return</span> <span class="nx">cerr</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">},</span>
		<span class="p">}</span>

		<span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">body</span>
		<span class="k">if</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">addedGzip</span> <span class="o">&amp;&amp;</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">EqualFold</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">),</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">gzipReader</span><span class="p">{</span><span class="nx">body</span><span class="p">:</span> <span class="nx">body</span><span class="p">}</span>
			<span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">)</span>
			<span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">)</span>
			<span class="nx">resp</span><span class="p">.</span><span class="nx">ContentLength</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
			<span class="nx">resp</span><span class="p">.</span><span class="nx">Uncompressed</span> <span class="p">=</span> <span class="kc">true</span>
		<span class="p">}</span>

		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">responseAndError</span><span class="p">{</span><span class="nx">res</span><span class="p">:</span> <span class="nx">resp</span><span class="p">}:</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">rc</span><span class="p">.</span><span class="nx">callerGone</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="p">}</span>

		<span class="c1">// Before looping back to the top of this function and peeking on
</span><span class="c1"></span>		<span class="c1">// the bufio.Reader, wait for the caller goroutine to finish
</span><span class="c1"></span>		<span class="c1">// reading the response body. (or for cancelation or death)
</span><span class="c1"></span>		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">bodyEOF</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">waitForBodyRead</span><span class="p">:</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="c1">// before pc might return to idle pool
</span><span class="c1"></span>			<span class="nx">alive</span> <span class="p">=</span> <span class="nx">alive</span> <span class="o">&amp;&amp;</span>
				<span class="nx">bodyEOF</span> <span class="o">&amp;&amp;</span>
				<span class="p">!</span><span class="nx">pc</span><span class="p">.</span><span class="nx">sawEOF</span> <span class="o">&amp;&amp;</span>
				<span class="nx">pc</span><span class="p">.</span><span class="nf">wroteRequest</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
				<span class="nf">tryPutIdleConn</span><span class="p">(</span><span class="nx">trace</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">bodyEOF</span> <span class="p">{</span>
				<span class="nx">eofc</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">Cancel</span><span class="p">:</span>
			<span class="nx">alive</span> <span class="p">=</span> <span class="kc">false</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">CancelRequest</span><span class="p">(</span><span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">)</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Done</span><span class="p">():</span>
			<span class="nx">alive</span> <span class="p">=</span> <span class="kc">false</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">cancelRequest</span><span class="p">(</span><span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">().</span><span class="nf">Err</span><span class="p">())</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">pc</span><span class="p">.</span><span class="nx">closech</span><span class="p">:</span>
			<span class="nx">alive</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="p">}</span>

		<span class="nf">testHookReadLoopBeforeNextRead</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></div><h4 id="writeloop">writeLoop<a href="#writeloop" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span> <span class="nf">writeLoop</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">pc</span><span class="p">.</span><span class="nx">writeLoopDone</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">wr</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">pc</span><span class="p">.</span><span class="nx">writech</span><span class="p">:</span>
			<span class="nx">startBytesWritten</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">nwrite</span>
			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">wr</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nx">pc</span><span class="p">.</span><span class="nx">bw</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">isProxy</span><span class="p">,</span> <span class="nx">wr</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">extra</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">waitForContinue</span><span class="p">(</span><span class="nx">wr</span><span class="p">.</span><span class="nx">continueCh</span><span class="p">))</span>
			<span class="k">if</span> <span class="nx">bre</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">requestBodyReadError</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
				<span class="nx">err</span> <span class="p">=</span> <span class="nx">bre</span><span class="p">.</span><span class="kt">error</span>
				<span class="c1">// Errors reading from the user&#39;s
</span><span class="c1"></span>				<span class="c1">// Request.Body are high priority.
</span><span class="c1"></span>				<span class="c1">// Set it here before sending on the
</span><span class="c1"></span>				<span class="c1">// channels below or calling
</span><span class="c1"></span>				<span class="c1">// pc.close() which tears town
</span><span class="c1"></span>				<span class="c1">// connections and causes other
</span><span class="c1"></span>				<span class="c1">// errors.
</span><span class="c1"></span>				<span class="nx">wr</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nf">setError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">err</span> <span class="p">=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">bw</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">wr</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
				<span class="k">if</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">nwrite</span> <span class="o">==</span> <span class="nx">startBytesWritten</span> <span class="p">{</span>
					<span class="nx">err</span> <span class="p">=</span> <span class="nx">nothingWrittenError</span><span class="p">{</span><span class="nx">err</span><span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="nx">pc</span><span class="p">.</span><span class="nx">writeErrCh</span> <span class="o">&lt;-</span> <span class="nx">err</span> <span class="c1">// to the body reader, which might recycle us
</span><span class="c1"></span>			<span class="nx">wr</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">err</span>         <span class="c1">// to the roundTrip function
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">pc</span><span class="p">.</span><span class="nb">close</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">pc</span><span class="p">.</span><span class="nx">closech</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="respbody">resp.Body<a href="#respbody" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>我们在读取response body返回的时候，要求我们执行下resp.Body.Close(), 为什么要这么做？ 我们看下对应的Body.Close都做了些什么？</p>
<h4 id="close">Close<a href="#close" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>Body.Close</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">es</span> <span class="o">*</span><span class="nx">bodyEOFSignal</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">es</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">es</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">es</span><span class="p">.</span><span class="nx">closed</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="nx">es</span><span class="p">.</span><span class="nx">closed</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="c1">// 关闭
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">es</span><span class="p">.</span><span class="nx">earlyCloseFn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">es</span><span class="p">.</span><span class="nx">rerr</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">es</span><span class="p">.</span><span class="nf">earlyCloseFn</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">es</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="k">return</span> <span class="nx">es</span><span class="p">.</span><span class="nf">condfn</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h4 id="earlyclosefn">earlyCloseFn<a href="#earlyclosefn" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>earlyCloseFn 就是这段，当调用Body.Close后readLoop就会执行earlyCloseFn</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">		<span class="nx">body</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">bodyEOFSignal</span><span class="p">{</span>
			<span class="nx">body</span><span class="p">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span>
			<span class="nx">earlyCloseFn</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
				<span class="nx">waitForBodyRead</span> <span class="o">&lt;-</span> <span class="kc">false</span>
				<span class="o">&lt;-</span><span class="nx">eofc</span> <span class="c1">// will be closed by deferred call at the end of the function
</span><span class="c1"></span>				<span class="k">return</span> <span class="kc">nil</span>

			<span class="p">},</span>
			<span class="nx">fn</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
				<span class="nx">isEOF</span> <span class="o">:=</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
				<span class="nx">waitForBodyRead</span> <span class="o">&lt;-</span> <span class="nx">isEOF</span>
				<span class="k">if</span> <span class="nx">isEOF</span> <span class="p">{</span>
					<span class="o">&lt;-</span><span class="nx">eofc</span> <span class="c1">// see comment above eofc declaration
</span><span class="c1"></span>				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="k">if</span> <span class="nx">cerr</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">canceled</span><span class="p">();</span> <span class="nx">cerr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
						<span class="k">return</span> <span class="nx">cerr</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">},</span>
		<span class="p">}</span>
</code></pre></div><h4 id="readloop-1">readLoop<a href="#readloop-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>readLoop退出前会执行tryPutIdleConn将空闲连接放入到连接池，然后执行defer close</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nb">close</span><span class="p">(</span><span class="nx">closeErr</span><span class="p">)</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">removeIdleConn</span><span class="p">(</span><span class="nx">pc</span><span class="p">)</span>
	<span class="p">}()</span>

    <span class="nx">tryPutIdleConn</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">trace</span> <span class="o">*</span><span class="nx">httptrace</span><span class="p">.</span><span class="nx">ClientTrace</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">tryPutIdleConn</span><span class="p">(</span><span class="nx">pc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">closeErr</span> <span class="p">=</span> <span class="nx">err</span>
			<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">PutIdleConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">errKeepAlivesDisabled</span> <span class="p">{</span>
				<span class="nx">trace</span><span class="p">.</span><span class="nf">PutIdleConn</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">PutIdleConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">trace</span><span class="p">.</span><span class="nf">PutIdleConn</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">}</span>
</code></pre></div><h4 id="close-1">close<a href="#close-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>close 主要会去close pc.closech， pc.closech 关闭后，会将writeLoop释放掉</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span> <span class="nb">close</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">pc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="nx">pc</span><span class="p">.</span><span class="nf">closeLocked</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span> <span class="nf">closeLocked</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;nil error&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">pc</span><span class="p">.</span><span class="nx">broken</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="k">if</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">closed</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">pc</span><span class="p">.</span><span class="nx">closed</span> <span class="p">=</span> <span class="nx">err</span>
		<span class="k">if</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">alt</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// Do nothing; can only get here via getConn&#39;s
</span><span class="c1"></span>			<span class="c1">// handlePendingDial&#39;s putOrCloseIdleConn when
</span><span class="c1"></span>			<span class="c1">// it turns out the abandoned connection in
</span><span class="c1"></span>			<span class="c1">// flight ended up negotiating an alternate
</span><span class="c1"></span>			<span class="c1">// protocol. We don&#39;t use the connection
</span><span class="c1"></span>			<span class="c1">// freelist for http2. That&#39;s done by the
</span><span class="c1"></span>			<span class="c1">// alternate protocol&#39;s RoundTripper.
</span><span class="c1"></span>		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">errCallerOwnsConn</span> <span class="p">{</span>
				<span class="nx">pc</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
			<span class="p">}</span>
			<span class="nb">close</span><span class="p">(</span><span class="nx">pc</span><span class="p">.</span><span class="nx">closech</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">pc</span><span class="p">.</span><span class="nx">mutateHeaderFunc</span> <span class="p">=</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>这样当Close完毕后，readLoop和writeLoop都会关闭，如果我们读取了resp.Body 不去关闭，一是我们的持久连接不会复用；二是内存开销会变大(不断派生readLoop,writeLoop)，所以为了还是要关闭Body.Close</p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-06-27 09:36 &#43;0800</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://leonzyang.github.io/posts/py-singleleton/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;</span><br><span>Python-单例模式</span>
			</a>
			<a class="prev-post" href="https://leonzyang.github.io/posts/malloc/">
				<span class="post-nav-label">&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Go-深入理解内存分配</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2021 <a href="https://leonzyang.github.io">LeonZhao</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://leonzyang.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://leonzyang.github.io/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	

</body>

</html>
